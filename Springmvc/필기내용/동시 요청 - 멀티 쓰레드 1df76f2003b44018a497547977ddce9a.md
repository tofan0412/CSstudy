# 동시 요청 - 멀티 쓰레드

클라이언트에서 요청이 오면, WAS에서 처리를 하게 된다..

Q. 서블릿 객체를 도대체 누가 호출하는가? ⇒ 바로 쓰레드가 호출한다.

## 쓰레드

- 애플리케이션 코드를 하나하나 순차적으로 실행하는 것은 쓰레드
- 자바 main Thread를 처음 실행하면, main이라는 이름의 쓰레드가 실행된다.
- 쓰레드가 없다면 자바 application 실행이 불가능하다.
- 쓰레드는 한번에 하나의 코드 라인만 수행한다.
- 동시 처리가 필요하면, 쓰레드를 추가로 생성한다.

**쓰레드가 하나만 있을 때**

요청이 오면 연결에 쓰레드를 할당한다. 쓰레드는 servlet 객체를 호출하게 된다.

**쓰레드가 하나 있을 때, 다중 요청이 온다면**

처음 요청에 대해 쓰레드 & 서블릿을 통한 처리가 지연되고 있을 때, 또 다른 요청이 도달하게 된다면?

⇒ 요청2번은 쓸 수 있는 쓰레드가 없다. 따라서 쓰레드를 기다리게 된다.

> 이 경우 Deadlock 문제가 발생한다.
**해결하기 위해선?** 새로운 쓰레드를 만들면 된다. ⇒ 근데 만약 무수히 많은 요청이 오게 되면.. N개의 요청에 대해 N개의 쓰레드가 필요할 수도 있다.
> 

### 장점

- 동시 요청을 처리할 수 있다.
- 리소스가 허용될 때까지 처리가 가능하다.
- 하나의 쓰레드가 지연되어도, 나머지 쓰레드는 정상 동작한다.

### 단점

- 쓰레드 생성 비용은 매우 비싸다.
    - 고객의 요청이 올 때마다 새로운 쓰레드를 생성하면, 응답 속도가 늦어진다.
- 쓰레드는 컨텍스트 스위칭 비용이 발생한다. (A작업 → B작업 → A작업으로 순차적으로 적용할 때 발생하는 비용)
- 쓰레드 생성에 제한이 없다.
    - 고객 요청이 너무 많이 오면, CPU, 메모리 임계점을 넘어서 서버가 죽을 수도 있다.

## 쓰레드 풀

요청 1과 요청2가 오면, 쓰레드 풀 안에서 미리 만들어둔 쓰레드에 각각 할당하게 된다. (쓰레드 풀 안에 200개가 있다고 가정하자.)

응답까지 반환하게 되면, 다시 해당 쓰레드를 쓰레드 풀에 반환한다.

⇒ 쓰레드를 죽이고 생성하는 것이 아닌, 재활용을 하는 것!

만약 쓰레드 풀 size를 초과하는 요청이 오게 되면, 요청을 대기 OR 거절하게 된다. (맛집에서 10명 정도가 대기열을 받거나 그 이상의 손님은 거절하는 것..)

 

### 특징

- 필요한 쓰레드를 쓰레드 풀에 보관하고 관리한다.
- 쓰레드 풀에 생성 가능한 쓰레드의 최대치를 관리한다. 톰캣의 경우 최대 200개가 기본 설정이다.

### 사용

- 쓰레드가 필요하면 이미 생성되어 있는 쓰레드를 쓰레드 풀에 꺼내서 쓴다.
- 사용이 종료되면, 해당 쓰레드를 쓰레드 풀에 반납한다.
- 최대 쓰레드가 모두 사용중이라면 → 대기 또는 거절하도록 설정할 수 있다.

### 장점

- 쓰레드를 생성하고 종료하는 비용이 절약되며, 응답 시간이 빠르다.
- 생성 가능한 쓰레드의 최대치가 있으므로, 너무 많은 요청이 들어와도 기존 요청은 안전하게 처리할 수 있다.

### 실무팁

- WAS의 주요 튜닝 포인트는 최대 쓰레드(max thread) 수이다.
- 이 값을 너무 낮게 설정하면?
    - 동시 요청이 많으면, 서버 리소스는 여유롭지만 클라이언트는 응답이 지연된다.
- 너무 높게 설정하면?
    - 동시 요청이 많으면, CPU, 메모리 리소스 임계점 초과로 서버가 다운될 수 있다. (10,000개로 설정하면 10,000개의 요청을 모두 받아들인다. 근데 만약 서버의 사양이 10,000개를 처리할 수 없는 사양이라면..)
- 장애 발생시?
    - 클라우드면 일단 서버부터 늘리고 이후에 튜닝
    - 아니라면 평상시에 열심히 튜닝

### 쓰레드 풀의 적정 숫자

정해진 적정 숫자는 없다.

이를 최적화하기 위해 반드시 성능 테스트를 해야 한다.

⇒ 실제 서비스와 유사한 환경에서 테스트를 진행. JMeter, nGrinder, apache ab 등..

### 개발자는 마치 싱글 쓰레드 프로그래밍을 하듯이 편리하게 소스 코드를 개발할 수 있다. 단 멀티 쓰레드 환경이므로 싱글톤 객체(서블릿, 스프링 빈)는 주의해서 사용해야 한다.